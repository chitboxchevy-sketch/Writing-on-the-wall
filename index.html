<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simple Persistent Whiteboard</title>
    <!-- Load Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Inter font -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .canvas-container {
            width: 95vw;
            max-width: 600px;
            margin: 0 auto;
        }
        #whiteboardCanvas {
            border: 2px solid #1f2937;
            touch-action: none; /* Prevents mobile scrolling while drawing */
            background-color: white;
        }
    </style>
</head>
<body class="bg-gray-100 p-4 min-h-screen">

    <div class="canvas-container shadow-2xl rounded-xl bg-white p-4">
        <h1 class="text-3xl font-bold text-gray-800 mb-2 text-center">Shared Whiteboard</h1>
        <p id="user-info" class="text-sm text-gray-500 mb-4 text-center">User ID: Loading...</p>
        
        <!-- Canvas Element -->
        <canvas id="whiteboardCanvas" class="w-full rounded-lg"></canvas>

        <div class="flex flex-col sm:flex-row gap-2 mt-4">
            <!-- Save Button -->
            <button id="saveButton"
                class="flex-1 px-4 py-3 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 transition duration-150 active:scale-[0.98]">
                Save Drawing
            </button>
            
            <!-- Clear Button -->
            <button id="clearButton"
                class="flex-1 px-4 py-3 bg-red-500 text-white font-semibold rounded-lg shadow-md hover:bg-red-600 transition duration-150 active:scale-[0.98]">
                Clear Whiteboard
            </button>
        </div>
        
        <!-- Status Message -->
        <p id="statusMessage" class="text-sm mt-3 text-center text-gray-600 h-6"></p>
    </div>

    <!-- Firebase Imports -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // IMPORTANT: Use the provided global variables for environment setup
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-whiteboard-app';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let db;
        let auth;
        let userId = 'loading';
        let isAuthReady = false;

        // --- DOM Elements ---
        const canvas = document.getElementById('whiteboardCanvas');
        const ctx = canvas.getContext('2d');
        const saveButton = document.getElementById('saveButton');
        const clearButton = document.getElementById('clearButton');
        const statusMessage = document.getElementById('statusMessage');
        const userInfo = document.getElementById('user-info');

        // --- Drawing State ---
        let isDrawing = false;
        let lastX = 0;
        let lastY = 0;
        const LINE_COLOR = '#000000';
        const LINE_WIDTH = 5;

        // --- Firebase Initialization and Auth ---
        function initFirebase() {
            try {
                if (Object.keys(firebaseConfig).length > 0) {
                    const app = initializeApp(firebaseConfig);
                    db = getFirestore(app);
                    auth = getAuth(app);
                    
                    // Set log level for debugging
                    setLogLevel('debug');
                } else {
                    console.error("Firebase config is empty. Cannot initialize.");
                    statusMessage.textContent = "Error: Firebase configuration missing.";
                    return;
                }

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        userInfo.textContent = `User ID: ${userId}`;
                        isAuthReady = true;
                        // Once authenticated, load the existing drawing
                        await loadDrawing();
                    } else {
                        // Attempt to sign in if no user is present
                        try {
                            if (initialAuthToken) {
                                await signInWithCustomToken(auth, initialAuthToken);
                            } else {
                                await signInAnonymously(auth);
                            }
                        } catch (error) {
                            console.error("Auth error:", error);
                            statusMessage.textContent = "Error authenticating.";
                        }
                    }
                });

            } catch (e) {
                console.error("Firebase initialization failed:", e);
                statusMessage.textContent = "Error during Firebase initialization.";
            }
        }

        // --- Firestore Utilities ---

        // Path to the shared whiteboard state document (refresh-based sharing)
        const whiteboardDocPath = () => 
            `/artifacts/${appId}/public/data/whiteboard_state/current_drawing`;

        /**
         * Saves the current canvas state as a Data URL to Firestore.
         */
        async function saveDrawing() {
            if (!isAuthReady) {
                statusMessage.textContent = "Please wait, authentication in progress...";
                return;
            }

            // Convert canvas content to base64 Data URL (PNG format)
            const drawingData = canvas.toDataURL('image/png');
            
            statusMessage.textContent = "Saving...";
            
            try {
                const docRef = doc(db, whiteboardDocPath());
                await setDoc(docRef, {
                    dataURL: drawingData,
                    updatedAt: new Date().toISOString(),
                    lastUserId: userId
                });
                statusMessage.textContent = `Saved successfully by ${userId.substring(0, 8)}...`;
            } catch (e) {
                console.error("Error saving document: ", e);
                statusMessage.textContent = "Save failed! Check console for errors.";
            }
        }

        /**
         * Loads the canvas state from Firestore and draws it onto the canvas.
         */
        async function loadDrawing() {
            if (!isAuthReady) {
                // If not ready, this function will be called again once auth is complete
                return;
            }

            statusMessage.textContent = "Loading last drawing...";
            
            try {
                const docRef = doc(db, whiteboardDocPath());
                const docSnap = await getDoc(docRef);

                if (docSnap.exists()) {
                    const data = docSnap.data();
                    const dataURL = data.dataURL;

                    if (dataURL) {
                        const img = new Image();
                        img.onload = () => {
                            // Ensure the canvas is cleared before drawing the loaded image
                            ctx.clearRect(0, 0, canvas.width, canvas.height);
                            // Draw the loaded image data
                            ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                            
                            const lastUser = data.lastUserId ? data.lastUserId.substring(0, 8) + '...' : 'Unknown';
                            statusMessage.textContent = `Loaded by ${userId.substring(0, 8)}... (Last saved by ${lastUser})`;
                        };
                        img.onerror = () => {
                            statusMessage.textContent = "Error loading image data.";
                            console.error("Image loading failed from DataURL.");
                        };
                        img.src = dataURL;
                    } else {
                        statusMessage.textContent = "No drawing data found.";
                    }
                } else {
                    statusMessage.textContent = "No previous drawing found. Start drawing!";
                }
            } catch (e) {
                console.error("Error loading document: ", e);
                statusMessage.textContent = "Error loading data.";
            }
        }

        // --- Canvas Drawing Logic ---
        
        /**
         * Recalculates canvas dimensions to match the container and set drawing style.
         */
        function resizeCanvas() {
            // Get the computed style of the container for dynamic sizing
            const container = canvas.parentElement;
            
            // Set canvas size based on its container size (important for mobile responsiveness)
            // Use clientWidth and clientHeight for actual pixel dimensions
            canvas.width = container.clientWidth - 32; // -32 for padding/margins
            canvas.height = Math.min(canvas.width * 0.75, 450); // Maintain a 4:3 aspect ratio, max 450px height

            // Restore line style settings after resize
            ctx.strokeStyle = LINE_COLOR;
            ctx.lineWidth = LINE_WIDTH;
            ctx.lineJoin = 'round';
            ctx.lineCap = 'round';
            
            // Reload the drawing to fit the new size
            if (isAuthReady) {
                loadDrawing();
            }
        }
        
        /**
         * Starts the drawing process.
         */
        function startDrawing(e) {
            e.preventDefault();
            isDrawing = true;
            // Get coordinates based on whether it's a mouse or touch event
            [lastX, lastY] = getCoords(e);
            
            // Start a new path immediately for a single dot on tap
            ctx.beginPath();
            ctx.moveTo(lastX, lastY);
            ctx.lineTo(lastX, lastY);
            ctx.stroke();
        }

        /**
         * Draws the line segment.
         */
        function draw(e) {
            if (!isDrawing) return;
            e.preventDefault();

            const [currentX, currentY] = getCoords(e);
            
            ctx.beginPath();
            ctx.moveTo(lastX, lastY);
            ctx.lineTo(currentX, currentY);
            ctx.stroke();

            [lastX, lastY] = [currentX, currentY];
        }

        /**
         * Stops the drawing process.
         */
        function stopDrawing() {
            if (!isDrawing) return;
            isDrawing = false;
        }

        /**
         * Clears the canvas visually and informs the user.
         */
        function clearCanvas() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            statusMessage.textContent = "Whiteboard cleared locally. Press 'Save' to share the empty canvas.";
        }
        
        /**
         * Gets normalized coordinates from mouse or touch events.
         */
        function getCoords(e) {
            const rect = canvas.getBoundingClientRect();
            let clientX, clientY;

            if (e.touches && e.touches.length > 0) {
                clientX = e.touches[0].clientX;
                clientY = e.touches[0].clientY;
            } else {
                clientX = e.clientX;
                clientY = e.clientY;
            }

            // Return coordinates relative to the canvas
            return [
                clientX - rect.left,
                clientY - rect.top
            ];
        }

        // --- Event Listeners ---
        window.addEventListener('resize', resizeCanvas);
        saveButton.addEventListener('click', saveDrawing);
        clearButton.addEventListener('click', clearCanvas);

        // Mouse events
        canvas.addEventListener('mousedown', startDrawing);
        canvas.addEventListener('mousemove', draw);
        canvas.addEventListener('mouseup', stopDrawing);
        canvas.addEventListener('mouseout', stopDrawing); 

        // Touch events (for mobile)
        canvas.addEventListener('touchstart', startDrawing);
        canvas.addEventListener('touchmove', draw);
        canvas.addEventListener('touchend', stopDrawing);
        canvas.addEventListener('touchcancel', stopDrawing); 

        // --- Initialization on load ---
        window.onload = () => {
            // First, size the canvas correctly
            resizeCanvas(); 
            // Then, initialize Firebase and attempt to load data
            initFirebase();
        };

    </script>
</body>
</html>

